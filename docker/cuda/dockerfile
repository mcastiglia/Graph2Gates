FROM nvidia/cuda:13.0.2-base-ubuntu22.04
LABEL maintainer="Michael Castiglia <michael.castiglia@ucf.edu>"
LABEL description="Dockerfile for OpenROAD (CUDA)"

RUN set -e && \
    export DEBIAN_FRONTEND=noninteractive && \
    apt-get update && \
    apt-get install -y --no-install-recommends \
        ca-certificates curl xz-utils dpkg tar \
        tcl tk libtcl8.6 libreadline8 zlib1g tclreadline libgomp1 \
        libqt5charts5 libqt5widgets5 libqt5gui5 libqt5core5a libqt5svg5 \
        qtbase5-dev qttools5-dev libqt5xmlpatterns5-dev qtmultimedia5-dev \
        libqt5multimediawidgets5 libqt5svg5-dev \
        libx11-xcb1 libxkbcommon0 libxkbcommon-x11-0 libxcb-icccm4 libxcb-image0 \
        libxcb-keysyms1 libxcb-render-util0 libxcb-xinerama0 libgl1 \
        libpython3.10 python3.10-minimal make python3 python3-dev python3-pip \
        libz-dev libgit2-dev ruby ruby-dev time python3-venv && \
    rm -rf /var/lib/apt/lists/*

RUN set -e && \
    curl -L -o /tmp/ortools.tar.gz \
      "https://github.com/google/or-tools/releases/download/v9.14/or-tools_amd64_ubuntu-22.04_cpp_v9.14.6206.tar.gz" && \
    mkdir -p /opt/ortools && \
    tar -xzf /tmp/ortools.tar.gz -C /opt/ortools --strip-components=1 && \
    rm -f /tmp/ortools.tar.gz

RUN set -e && \
    curl -L -o /tmp/openroad.deb \
      "https://github.com/Precision-Innovations/OpenROAD/releases/download/2024-12-14/openroad_2.0-17598-ga008522d8_amd64-ubuntu-22.04.deb" && \
    mkdir -p /opt/openroad-root && \
    dpkg-deb -x /tmp/openroad.deb /opt/openroad-root && \
    rm -f /tmp/openroad.deb && \
    ln -sf /opt/openroad-root/usr/bin/openroad /usr/local/bin/openroad

RUN set -e && \
    curl -L -o /tmp/oss-cad-suite.tar.gz \
      "https://github.com/YosysHQ/oss-cad-suite-build/releases/download/2025-09-13/oss-cad-suite-linux-x64-20250913.tgz" && \
    mkdir -p /opt/oss-cad-suite && \
    tar -xzf /tmp/oss-cad-suite.tar.gz -C /opt/oss-cad-suite --strip-components=1 && \
    rm -f /tmp/oss-cad-suite.tar.gz

RUN set -e && \
    curl -L -o /tmp/klayout.deb \
      "https://www.klayout.org/downloads/Ubuntu-22/klayout_0.30.4-1_amd64.deb" && \
    mkdir -p /opt/klayout && \
    dpkg-deb -x /tmp/klayout.deb /opt/klayout && \
    rm -f /tmp/klayout.deb

RUN set -e && \
    python3 -m venv /opt/venv && \
    . /opt/venv/bin/activate && \
    pip install --upgrade pip && \
    pip install pyyaml numpy tqdm scipy gym torch-geometric stable-baselines3

RUN set -e && . /opt/venv/bin/activate && pip install torch

ENV PATH="/usr/local/bin:/opt/oss-cad-suite/bin:/opt/klayout/usr/bin:/opt/venv/bin:${PATH}"
ENV LD_LIBRARY_PATH="/opt/ortools/lib:/opt/openroad-root/usr/lib/x86_64-linux-gnu:/opt/klayout/usr/lib/klayout:/usr/lib/x86_64-linux-gnu"
ENV QT_QPA_PLATFORM=offscreen
ENV OPENROAD_EXE="/usr/local/bin/openroad"
ENV YOSYS_EXE="/opt/oss-cad-suite/bin/yosys"
ENV YOSYS_FLAGS=""

#RUN echo '#!/bin/bash\nset -e\nexport XDG_RUNTIME_DIR=/tmp/runtime-$(whoami)\nmkdir -p $XDG_RUNTIME_DIR\nchmod 700 $XDG_RUNTIME_DIR\n. /opt/venv/bin/activate\nexec openroad "$@"' > /entrypoint.sh && chmod +x /entrypoint.sh

#ENTRYPOINT ["/entrypoint.sh"]

